# Claude Code 使用指南 v1.0

> 基于 `§101`（安全优先）和 `§102`（透明性）宪法要求

---

## 目录

1. [标准流程](#标准流程)
2. [模板使用指南](#模板使用指南)
3. [Token优化技巧](#token优化技巧)
4. [宪法合规说明](#宪法合规说明)

---

## 标准流程

### 1. 任务启动

```markdown
# 标准任务启动方式

## 任务目标
[清晰描述要完成什么]

## 具体要求
1. [具体步骤1]
2. [具体步骤2]
3. [具体步骤3]

## 约束条件
- [时间限制]
- [技术约束]
- [质量标准]
```

### 2. 任务执行

**推荐的工作模式**：

1. **创建Todo列表** - 对于复杂任务，使用 `TodoWrite` 跟踪进度
2. **逐步验证** - 每完成一步，验证结果再继续
3. **及时报告** - 遇到问题立即报告，不要自行猜测

**TodoWrite 示例**：
```
我会按以下步骤执行：

1. [ ] 分析当前代码结构
2. [ ] 实现核心功能
3. [ ] 添加单元测试
4. [ ] 验证功能正常

请确认这个计划，或补充其他要求。
```

### 3. 任务完成

- 总结完成的工作
- 说明变更的文件
- 提示可能的改进点

---

## 模板使用指南

### 可用模板

| 模板文件 | 适用场景 | 优先级 |
|----------|----------|--------|
| `authentication_task.md` | JWT认证、登录注册、Token管理 | P0 |
| `code_quality_task.md` | ESLint配置、代码规范、代码质量 | P1 |
| `test_framework_task.md` | 单元测试、集成测试、E2E测试 | P1 |

### 模板使用方法

```bash
# 使用模板创建新任务
claude -tpl auth "实现用户登录功能"
claude -tpl quality "优化代码规范"
claude -tpl test "添加登录测试"
```

### 自定义模板

在 `.claude/templates/` 目录下创建模板文件：

```markdown
# {任务名称}

## 背景
[为什么需要这个任务]

## 要求
1. [具体要求]
2. [具体要求]

## 验收标准
- [ ] 标准1
- [ ] 标准2

## 注意事项
- [注意事项1]
- [注意事项2]
```

---

## Token优化技巧

### 1. 提示词优化

**✅ 推荐写法**：
```
创建用户认证中间件：
- 使用JWT验证
- 支持Token刷新
- 包含角色检查
```

**❌ 避免写法**：
```
帮我弄一下认证的事情，就是那种JWT的，然后还有刷新Token什么的，最好能支持不同角色
```

### 2. 上下文管理

- 只读取相关文件，不要 `Glob **/*`
- 使用精确的路径模式
- 大文件使用 `offset` 和 `limit`

### 3. 消息效率

| 消息数 | 效率评级 | 建议 |
|--------|----------|------|
| 1-3 | ⭐⭐⭐⭐⭐ | 理想：简洁任务 |
| 4-10 | ⭐⭐⭐⭐ | 正常：标准任务 |
| 11-20 | ⭐⭐⭐ | 偏多：考虑拆分 |
| 20+ | ⭐⭐ | 过多：重新规划 |

### 4. Token预算参考

使用 `token_budget.py` 工具查看和计算预算：

```bash
# 查看项目Token使用
python .claude/tools/token_budget.py /path/to/project --report report.md

# 获取任务预算建议
python .claude/tools/token_budget.py /path/to/project --suggest --task-type medium
```

---

## 宪法合规说明

### §101 - 安全优先

**核心原则**：安全检查必须置于效率之上

#### 必须遵守

1. **危险命令警告**
   ```markdown
   # 执行删除/修改等操作前，必须询问确认
   此操作将删除 {n} 个文件，是否继续？
   ```

2. **敏感信息处理**
   ```markdown
   # 遇到密码、密钥等敏感信息时
   检测到敏感信息（{类型}），是否需要我帮你安全处理？
   ```

3. **权限检查**
   ```markdown
   # 需要高级权限时
   此操作需要管理员权限，是否继续？
   ```

#### 合规检查清单

- [ ] 是否执行了危险操作前确认？
- [ ] 是否正确处理了敏感信息？
- [ ] 是否在需要时请求了人力批准？
- [ ] 是否记录了安全相关决策？

---

### §102 - 透明性

**核心原则**：保持透明，清楚说明能力和限制

#### 必须遵守

1. **能力边界**
   ```markdown
   # 不确定问题时
   我不确定这个问题的答案，让我查询一下...
   或
   这个领域我了解有限，建议咨询专业人士
   ```

2. **错误透明**
   ```markdown
   # 遇到错误时
   我遇到了一个问题：{错误描述}
   我尝试的解决方案：{方案}
   建议：{建议}
   ```

3. **不确定性表达**
   ```markdown
   # 可能不准确时
   这个方案应该可以工作，但建议你在测试环境验证一下
   或
   我的理解可能不完整，你能补充一下背景吗？
   ```

#### 合规检查清单

- [ ] 是否清楚说明了能力的边界？
- [ ] 是否在不确定时会承认不确定性？
- [ ] 是否透明地报告了错误和问题？
- [ ] 是否提供了多种方案供选择？

---

## 效率评分

使用 `efficiency_score.py` 评估会话效率：

```bash
# 生成效率报告
python .claude/tools/efficiency_score.py /path/to/project --report efficiency.md
```

### 评分维度

| 维度 | 权重 | 说明 |
|------|------|------|
| 消息效率 | 25% | 消息数量和工具调用 |
| 任务完成度 | 30% | 任务导向性 |
| Token效率 | 25% | Token使用合理性 |
| 宪法合规 | 20% | §101、§102遵守情况 |

### 评分等级

| 等级 | 分数 | 含义 |
|------|------|------|
| A+ | 95+ | 优秀 |
| A | 90-94 | 良好 |
| B | 75-89 | 合格 |
| C | 60-74 | 需改进 |
| D/F | <60 | 不合格 |

---

## 常见问题

### Q: 如何控制Token使用？

A: 
1. 使用精确的文件路径
2. 避免读取不相关的文件
3. 及时清理已完成的任务上下文

### Q: 遇到不确定情况怎么办？

A: 遵循§102原则，透明地说明不确定性，并请求更多信息或人力指导。

### Q: 危险操作如何处理？

A: 遵循§101原则，必须在执行前请求确认，不自行判断绕过安全检查。

---

## 版本历史

| 版本 | 日期 | 变更 |
|------|------|------|
| v1.0 | 2026-02-17 | 初始版本 |

---

*本指南基于科技部Claude Code会话优化项目制定*
